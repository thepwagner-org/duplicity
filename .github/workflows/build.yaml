name: Build
on:
  push:
  # workflow_dispatch is a glassbreak that rebuilds without cache
  # intended to hotfix packages not yet in the base image
  workflow_dispatch:
  
permissions:
  contents: read
jobs:
  test:
    runs-on: self-hosted
    steps:
    - name: "ğŸ¤“ Fetching code"
      uses: actions/checkout@5a4ac9002d0be2fb38bd78e4b4dbde5606d7042f # renovate: tag=v2
    - name: "ğŸï¸ Pull image from cache"
      if: ${{github.event_name != 'workflow_dispatch'}}
      run: docker pull "registry.k8s.pwagner.net/library/duplicity:latest"
    
    - name: "ğŸš§ Build image"
      run: docker build --cache-from "registry.k8s.pwagner.net/library/duplicity:latest" -t "registry.k8s.pwagner.net/library/duplicity:${{github.sha}}" .
    
    - name: "ğŸ•µï¸ Scan image"
      uses: docker://registry.k8s.pwagner.net/library/trivy:latest@sha256:aa76c0dd41e64476fd4e2e3e8d39830cd145f36a087a14acf5a24fe8db044aa6
      with:
        args: registry.k8s.pwagner.net/library/duplicity:${{github.sha}}
    # Deploy 'main' branch to registry
    - name: "ğŸš¢ Login to registry for publish"
      if: ${{github.ref == 'refs/heads/main'}}
      uses: docker/login-action@f054a8b539a109f9f41c372932f1ae047eff08c9 # renovate: tag=v1
      with:
        registry: registry.k8s.pwagner.net
        username: robot$github-actions
        password: ${{secrets.REGISTRY_K8S_PASSWORD}}
    - name: "ğŸš¢ Publish to registry"
      if: ${{github.ref == 'refs/heads/main'}}
      run: |
        docker tag registry.k8s.pwagner.net/library/duplicity:${{github.sha}} registry.k8s.pwagner.net/library/duplicity:latest
        docker push registry.k8s.pwagner.net/library/duplicity:latest
