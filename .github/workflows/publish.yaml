name: Publish
on:
  push:
    branches:
      - main

permissions:
  contents: write 
  actions: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: "🌎 Fetching code"
        uses: actions/checkout@dcd71f646680f2efd8db4afa5ad64fdcba30e748 # tag=v3
        with:
          persist-credentials: false
      - name: "🌎 Logging in to Docker Registry"
        uses: docker/login-action@dd4fa0671be5250ee6f50aedf4cb05514abda2c7 # tag=v1
        with:
          registry: ghcr.io
          username: ${{github.repository_owner}}
          password: ${{secrets.WAPWAGNER_TOKEN}}

      - name: "🚧 Building image"
        run: docker build -t ghcr.io/thepwagner-org/duplicity:${{github.sha}} .

      - name: "🕵️ Setup Syft"
        uses: anchore/sbom-action/download-syft@407a3ec314b07e326eff3ba171091cbc150460a8 # tag=v0.10.0
      - name: "🕵️ Generate SBOM"
        run: syft packages -o spdx-json=sbom.spdx.json ghcr.io/thepwagner-org/duplicity:${{github.sha}}

      - name: "👮 Verify SBOM"
        run: |
          # Exit if packages match the committed SBOM
          BUILT_PACKAGES=$(jq -r '.packages[].externalRefs[] | select(.referenceType=="purl") .referenceLocator' sbom.spdx.json | sort)
          printf "Built packages:\n%s\n" "$BUILT_PACKAGES"
          
          STORED_PACKAGES=$(jq -r '.packages[].externalRefs[] | select(.referenceType=="purl") .referenceLocator' Dockerfile.spdx.json| sort)
          printf "Stored packages:\n%s\n" "$STORED_PACKAGES"

          (diff -b -U 0 stored.txt built.txt || true) > pkgdiff.txt
          [[ -s pkgdiff.txt ]] && exit 1

          docker tag ghcr.io/thepwagner-org/duplicity:${{github.sha}} ghcr.io/thepwagner-org/duplicity:latest
          docker push ghcr.io/thepwagner-org/duplicity:latest
